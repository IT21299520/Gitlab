class Projects::NewTreeController < Projects::BaseTreeController
  before_filter :require_branch_head
  before_filter :authorize_push_code!

  def show
  end

  def update
<<<<<<< HEAD
	flag = 0
	#replace & upload 
	if params[:file_upload] != nil
		#get the name of the upload file
		file_na = params[:file_upload].original_filename
		file_path = nil
=======
	flag=0
	#replace & upload 
	if params[:file_upload] != nil
		#get the name of the upload file
		file_na=params[:file_upload].original_filename
		file_path=nil
>>>>>>> 7ac8341... Update new_tree_controller.rb
		
	    if file_na != nil
			file_list = tree.entries.select(&:file?)
			dir_list = tree.entries.select(&:dir?)
			
<<<<<<< HEAD
			#check whether current path is sub-repository
			dir_list.each do |dir|		
				if dir.name != nil
					flag = 1
				end
			end
			
			#check whether current path is sub-repository
			file_list.each do |file|	
				if file.name != nil
					flag = 1
				end
			end
			
			if @path.match(/(.*\/)*(.+)\z/) != nil && flag == 0	#replace existing file
				flag = 2
				params[:content] = params[:file_upload].read
				params[:file_name] = @path	
				file_path = @path
				result = Files::UploadService.new(@project, current_user, params, @ref, @path).execute
			end
				
			if flag == 1 || flag == 0	#upload new file	
				flag = 3
=======
			dir_list.each do |dir|		#check whether current path is sub-repository
				if dir.name != nil
					flag=1
				end
			end
			
			file_list.each do |file|	#check whether current path is sub-repository
				if file.name != nil
					flag=1
				end
			end
			
			if @path.match(/(.*\/)*(.+)\z/) != nil && flag==0	#replace existing file
				flag=2
				params[:content]=params[:file_upload].read
				params[:file_name]=@path	
				file_path=@path
				result=Files::UploadService.new(@project, current_user, params, @ref, @path).execute
			end
				
			if flag==1 || flag==0	#upload new file	
				flag=3
>>>>>>> 7ac8341... Update new_tree_controller.rb
				file_list.each do |file|				
					if file.name == file_na
						flash[:alert] = file.name + " already exists!"
						redirect_to project_blob_path(@project, File.join(@ref, @path))
						return 
					end
				end
<<<<<<< HEAD
				params[:content] = params[:file_upload].read
				params[:file_name] = file_na	
=======
				params[:content]=params[:file_upload].read
				params[:file_name]=file_na	
>>>>>>> 7ac8341... Update new_tree_controller.rb
				file_path = File.join(@path, File.basename(params[:file_name]))
				result = Files::CreateService.new(@project, current_user, params, @ref, file_path).execute
			end
		end
	end 
	
<<<<<<< HEAD
	if flag == 0
=======
	if flag==0
>>>>>>> 7ac8341... Update new_tree_controller.rb
		file_path = File.join(@path, File.basename(params[:file_name]))
		result = Files::CreateService.new(@project, current_user, params, @ref, file_path).execute
	end
	
<<<<<<< HEAD
    	if result[:status] == :success
=======
    if result[:status] == :success
>>>>>>> 7ac8341... Update new_tree_controller.rb
		flash[:notice] = "Your changes have been successfully commited."		
		redirect_to project_blob_path(@project, File.join(@ref, file_path))
	else
		flash[:alert] = result[:message]
		render :show
    end
  end
end
